#!/usr/bin/env python3
"""CODE7 - Slack-optimized instant check"""
import requests
from datetime import datetime
import sys

REDASH_API_KEY = "wPoSJ9zxm7gAu5GYU44w3bY9hBmagjTMg7LfqDBH"
REDASH_BASE_URL = "https://redash.zp-int.com"
REDASH_QUERY_ID = "133695"

result = []
try:
    headers = {"Authorization": f"Key {REDASH_API_KEY}"}
    results_url = f"{REDASH_BASE_URL}/api/queries/{REDASH_QUERY_ID}/results.json"
    response = requests.get(results_url, headers=headers, timeout=5)
    response.raise_for_status()
    rows = response.json()['query_result']['data']['rows']
    count = len(rows)
    today = datetime.now().strftime('%A, %B %d, %Y')
    
    if count == 0:
        result.append(f"‚ö†Ô∏è No Transactions - {today}")
        result.append(f"üìä Weekend/Holiday")
        result.append(f"‚úÖ CODE7 Complete")
    else:
        result.append(f"‚úÖ {count} Transactions - {today}")
        result.append(f"‚öôÔ∏è Processing...")
        result.append(f"üìÅ Run: python3 code7.py")
except Exception as e:
    result.append(f"‚ùå Error: {e}")

# Print to stdout and flush
output = "\n".join(result)
print(output, flush=True)
sys.stdout.flush()

# Also save to file for backup
with open("/tmp/code7_last_run.txt", "w") as f:
    f.write(output)

